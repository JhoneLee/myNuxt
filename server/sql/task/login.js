/**
 * @file 登录数据库控制脚本
 * @Author liyunjiao
 * @Date 2018-12-26 15:23:14
 * @Last Modified by:   liyunjiao2048@163.com
 * @Last Modified time: 2019-03-26 16:43:12
 */

'import%20%7Bquery%7D%20from%20%27../pool%27%3B%0Aimport%20%7BtimeStamp2String%7D%20from%20%27../../utils/tools%27%3B%0A%0Aasync%20function%20login%28opt%29%20%7B%0A%20%20%20%20let%20arr%20%3D%20%5B%5D%3B%0A%20%20%20%20for%20%28let%20item%20in%20opt%29%20%7B%0A%20%20%20%20%20%20%20%20arr.push%28%60%24%7Bitem%7D%3D%27%24%7Bopt%5Bitem%5D%7D%27%60%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20sql%20%3D%20%60select%20a.user_name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.nick_name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.user_id%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.oid%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.password%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.redirect_url%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b.relation%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20from%20%20user_info_table%20a%20left%20join%20jgs_relation_list%20b%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%20a.oid%3Db.oid%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20where%20%24%7Barr.join%28%27%20and%20%27%29%7D%60%3B%0A%20%20%20%20let%20result%20%3D%20await%20query%28sql%29.then%28res%3D%3E%7B%0A%20%20%20%20%20%20%20%20return%20res%3B%0A%20%20%20%20%7D%29.catch%28e%3D%3Efalse%29%3B%0A%20%20%20%20if%20%28result%29%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20data%3A%20result%5B0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%20%27success%27%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%20%27db%20error%27%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%0A%7D%0A%0Aasync%20function%20addLoginLog%28uid%2C%20ip%29%20%7B%0A%20%20%20%20const%20nowTimeStamp%20%3D%20timeStamp2String%28new%20Date%28%29%29%3B%0A%20%20%20%20const%20sql%20%3D%20%60INSERT%20INTO%20jgs_sysdb.jgs_login_log%20%28uid%2C%20ip%2C%20access_time%2C%20logout_time%29%0A%20%20%20%20%20%20%20%20VALUES%20%28%27%24%7Buid%7D%27%2C%20%27%24%7Bip%7D%27%2C%20%27%24%7BnowTimeStamp%7D%27%2C%20%27%27%29%3B%60%3B%0A%20%20%20%20return%20query%28sql%29.then%28data%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20data.insertId%3B%0A%20%20%20%20%7D%29.catch%28err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20console.log%28%27login%20log%20error%3A%27%2C%20err%29%3B%0A%20%20%20%20%20%20%20%20return%20err%3B%0A%20%20%20%20%7D%29%3B%0A%7D%0A%0Aasync%20function%20logout%28uid%2C%20logId%29%20%7B%0A%20%20%20%20const%20nowTimeStamp%20%3D%20timeStamp2String%28new%20Date%28%29%29%3B%0A%20%20%20%20const%20sql%20%3D%20%60UPDATE%20jgs_sysdb.jgs_login_log%0A%20%20%20%20%20%20%20%20SET%20logout_time%20%3D%20%27%24%7BnowTimeStamp%7D%27%20WHERE%20%28uid%20%3D%20%27%24%7Buid%7D%27%20AND%20log_id%20%3D%20%27%24%7BlogId%7D%27%29%3B%60%3B%0A%20%20%20%20return%20query%28sql%29.then%28data%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20data%3B%0A%20%20%20%20%7D%29.catch%28err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20err%3B%0A%20%20%20%20%7D%29%3B%0A%0A%7D%0A/*%20eslint-disable%20*/%0Aexport%20default%20%7B%0A%20%20%20%20login%2C%0A%20%20%20%20addLoginLog%2C%0A%20%20%20%20logout%0A%7D%3B'
