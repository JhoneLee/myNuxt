/**
* @file: 测试
* @Author: liyunjiao2048@163.com
* @Date:   2018-07-23 14:45:49
 * @Last Modified by:   liyunjiao2048@163.com
 * @Last Modified time: 2019-03-26 16:42:43
*/

// 获取用户信息
'import%20%7Bquery%7D%20from%20%27../pool%27%3B%0Aimport%20%7BtimeStamp2String%7D%20from%20%27../../utils/tools%27%3B%0Aimport%20uuid%20from%20%27node-uuid%27%3B%0A%0Aasync%20function%20getUserInfo%28opt%29%7B%0A%20%20%20%20let%20arr%20%3D%5B%5D%3B%0A%20%20%20%20for%28let%20item%20in%20opt%29%7B%0A%20%20%20%20%20%20%20%20arr.push%28%60%24%7Bitem%7D%3D%27%24%7Bopt%5Bitem%5D%7D%27%60%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20sql%20%3D%20%60select%20*%20from%20jgs_user_info%20where%20%24%7Barr.join%28%27%20and%20%27%29%7D%60%3B%0A%20%20%20%20let%20result%20%3D%20await%20query%28sql%29.then%28res%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20res%3B%0A%20%20%20%20%7D%29.catch%28e%20%3D%3E%20false%29%3B%0A%20%20%20%20if%20%28result%29%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20data%3A%20result%5B0%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%20%27success%27%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%20%27db%20error%27%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%0A%7D%0A%0Aasync%20function%20getComponentByCid%28cids%20%3D%20%5B%5D%29%20%7B%0A%20%20%20%20const%20sql%20%3D%20%60SELECT%20*%20FROM%20jgs_component_info%20where%20c_id%20in%20%28%24%7Bcids.join%28%29%7D%29%60%3B%0A%20%20%20%20const%20result%20%3D%20await%20query%28sql%29%3B%0A%20%20%20%20return%20JSON.parse%28JSON.stringify%28result%29%29%3B%0A%7D%0A%0Aasync%20function%20getFrameByOid%28userid%29%20%7B%0A%20%20%20%20const%20sql%20%3D%20%60%0A%20%20%20%20%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20%20%20%20%20db.user_info.user_name%20as%20username%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20db.jgs_user_info.nick_name%20as%20nickname%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_user_info.redirect_url%20as%20redirecturl%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20GROUP_CONCAT%28jgs_sysdb.jgs_relation_list.relation%20SEPARATOR%20%27%2C%27%29%20as%20relation%0A%20%20%20%20%20%20%20%20FROM%0A%20%20%20%20%20%20%20%20%20%20%20%20%28%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_origin_info%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20left%20join%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_user_info%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20jgs_origin_info.origin_id%20%3D%20jgs_user_info.user_id%0A%20%20%20%20%20%20%20%20%20%20%20%20%29%0A%20%20%20%20%20%20%20%20left%20join%0A%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_relation_list%20on%20jgs_relation_list.oid%20%3D%20jgs_origin_info.origin_id%0A%20%20%20%20%20%20%20%20where%0A%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_user_info.user_id%20%3D%20%24%7Buserid%7D%0A%20%20%20%20%20%20%20%20group%20by%0A%20%20%20%20%20%20%20%20%20%20%20%20jgs_sysdb.jgs_user_info.user_id%3B%60%3B%0A%20%20%20%20const%20result%20%3D%20await%20query%28sql%29.then%28res%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20res%3B%0A%20%20%20%20%7D%29.catch%28err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%7D%29%3B%0A%20%20%20%20if%20%28result%20%26%26%20result.length%29%20%7B%0A%20%20%20%20%20%20%20%20const%20userInfo%20%3D%20result%5B0%5D%3B%0A%20%20%20%20%20%20%20%20userInfo.relation%20%3D%20JSON.parse%28%60%5B%24%7BuserInfo.relation%7D%5D%60%29.reduce%28%28prev%2C%20next%29%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20prev.concat%28next%29%3B%0A%20%20%20%20%20%20%20%20%7D%29%3B%0A%20%20%20%20%20%20%20%20let%20componentsPromises%20%3D%20userInfo.relation.map%28async%20item%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20componentList%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%28item.components.length%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20componentList%20%3D%20await%20getComponentByCid%28item.components%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20item.components%20%3D%20componentList%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20item%3B%0A%20%20%20%20%20%20%20%20%7D%29%3B%0A%20%20%20%20%20%20%20%20return%20Promise.all%28componentsPromises%29.then%28%28%29%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20userInfo%3B%0A%20%20%20%20%20%20%20%20%7D%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20return%20%5B%5D%3B%0A%20%20%20%20%7D%0A%7D%0A%0Aasync%20function%20updateUserInfo%28oid%2Copt%29%7B%0A%20%20%20%20let%20arr%20%3D%5B%5D%3B%0A%20%20%20%20for%28let%20item%20in%20opt%29%7B%0A%20%20%20%20%20%20%20%20arr.push%28%60%24%7Bitem%7D%3D%24%7Bopt%5Bitem%5D%7D%60%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20sql%20%3D%20%60update%20user%20set%20%24%7Barr.join%28%27%2C%27%29%7D%20where%20openid%3D%24%7Boid%7D%60%3B%0A%20%20%20%20let%20result%20%3D%20await%20query%28sql%29.then%28res%3D%3Etrue%29.catch%28e%3D%3Efalse%29%3B%0A%20%20%20%20if%28result%29%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%27success%27%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%27db%20error%27%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Aasync%20function%20addUserInfo%28opt%29%7B%0A%20%20%20%20let%20%7Buser_name%2Cname%2Cuser_type%2Ccreate_time%2Ctoken%2Copenid%7D%20%3D%20opt%3B%0A%20%20%20%20openid%20%3D%20openid%20%7C%7C%20uuid.v4%28%29%3B%0A%20%20%20%20create_time%20%3D%20create_time%20%7C%7C%20timeStamp2String%28new%20Date%28%29%29%3B%0A%20%20%20%20user_type%20%3D%20user_type%20%7C%7C%200%3B%0A%20%20%20%20let%20sql%20%3D%20%60insert%20into%20user%28user_name%2Cname%2Cuser_type%2Ccreate_time%2Ctoken%2Copenid%29%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20values%28%24%7Buser_name%7D%2C%24%7Bname%7D%2C%24%7Buser_type%7D%2C%24%7Bcreate_time%7D%2C%24%7Btoken%7D%2C%24%7Bopenid%7D%29%60%3B%0A%20%20%20%20let%20result%20%3D%20await%20query%28sql%29.then%28res%3D%3Etrue%29.catch%28e%3D%3Efalse%29%3B%0A%20%20%20%20if%28result%29%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%27success%27%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20status%3A1%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20statusInfo%3A%27db%20error%27%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A/*%20eslint-disable%20*/%0Aexport%20default%20%7B%0A%20%20%20%20getFrameByOid%2C%0A%20%20%20%20getUserInfo%2C%0A%20%20%20%20updateUserInfo%2C%0A%20%20%20%20addUserInfo%0A%7D'